name: Update package README.md

on:
  push:
    branches: [ main ]
    paths:
      - 'images/**/README.md'
  workflow_dispatch:

jobs:
  discover:
    name: Discover
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v6

      - id: set-matrix
        run: |
          set -e
          PACKAGES=$(find images -maxdepth 1 -mindepth 1 -type d -exec basename {} \; | jq -R -s -c 'split("\n") | map(select(. != "")) | map({name: .})')
          echo "matrix=$PACKAGES" >> $GITHUB_OUTPUT

  update-readme:
    name: "Update README ${{ matrix.name }}"
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJson(needs.discover.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v6

      - name: Check README exists
        id: check-readme
        run: |
          set -e
          README_PATH="images/${{ matrix.name }}/README.md"
          if [ -f "$README_PATH" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "path=$README_PATH" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::warning::README not found at $README_PATH"
          fi

      - name: Update package README
        if: steps.check-readme.outputs.exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.DOCKER_IMAGE_PACKAGE_TOKEN }}
        run: |
          OWNER="${{ github.repository_owner }}"
          PACKAGE="${{ matrix.name }}"

          set -eo pipefail

          if ! command -v jq &> /dev/null; then
            echo "::error::jq is not installed"
            exit 1
          fi

          README_PATH="${{ steps.check-readme.outputs.path }}"

          if ! README_CONTENT=$(jq -Rs . < "$README_PATH"); then
            echo "::error::Failed to encode README content"
            exit 1
          fi

          if ! gh api \
            --method PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/users/${OWNER}/packages/container/${PACKAGE}" \
            -f readme="${README_CONTENT}"; then
            echo "::error::Failed to update package README"
            exit 1
          fi

          echo "README updated for package: ${PACKAGE}"
